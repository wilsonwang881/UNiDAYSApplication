<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=yes">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="css/bootstrap.min.css">

    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS, then Vue.js -->
    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/vue.min.js"></script>

    <title>Price Calculator</title>

    <script>
    var item = [];
    var shoppingCart = [];

    var defaultPricingRule = {
      A: {price: 8,
          discount: "none"},
      B: {price: 12,
          discount: "2 cost 20"},
      C: {price: 4,
          discount: "3 cost 10"},
      D: {price: 7,
          discount: "1 free 1"},
      E: {price: 5,
          discount: "3 for 2"}
    };

    class UnidaysDiscountChallenge  {
      constructor(pricingRules) {
        this._total = 0;
        this._deliveryCharge = 0;
        this._pricingRules = pricingRules;
        this._basket = {};

        for(var key in this._pricingRules) {
          this._basket[key] = 0;
        }
      }

      total() {
        return Number(this._total).toFixed(2);
      }

      deliveryCharge() {
        return Number(this._deliveryCharge).toFixed(2);
      }

      basket() {
        return this._basket;
      }

      addToBasket(item) {
        try {
          this._basket[item] += 1;
        }
        catch(err) {
          alert("Item does not exist");
        }
      }

      removeFromBasket(item) {
        try {
          if(this._basket[item]>0){
            this._basket[item] -= 1;
          }
          else{
            this._basket[item] = 0;
          }
        }
        catch(err) {
          alert("Item does not exist");
        }
      }

      interpretPricingPolicy(item, amount) {
        var price = this._pricingRules[item]["price"];

        if(this._pricingRules[item]["discount"]=="none"){
          return price*amount;
        }
        else{
          var policy = this._pricingRules[item]["discount"].split(" ");
          var individualCost = this._pricingRules[item]["price"];
          var cost = 0;

          switch (policy[1]) {
            case "cost":
              var bundle = policy[0];
              var bundleCost = policy[2];
              var remainCount = amount % bundle;
              var bundleCount = (amount - remainCount) / bundle;
              cost = bundleCost * bundleCount + remainCount * individualCost;
              break;
            case "free":
              var bundlePay = policy[0];
              var bundleFree = policy[2];
              var remainCount = Number(amount) % (Number(bundlePay) + Number(bundleFree));
              var bundleCount = (amount - remainCount) / (Number(bundlePay) + Number(bundleFree));
              cost = bundleCount * bundlePay * individualCost + remainCount * individualCost;
              break;
            case "for":
              var bundleActual = policy[0];
              var bundlePay = policy[2];
              var bundleRemain = amount % bundleActual;
              var bundleCount = (amount - bundleRemain) / bundleActual;
              cost = bundleCount * bundlePay * individualCost + bundleRemain * individualCost;
              break;
            default:
              break;
          }

          return cost;
        }
      }

      calculateTotalPrice() {
        this._total = 0;

        for(var key in this._basket) {
          if(this._basket[key]>0){
            this._total += this.interpretPricingPolicy(key, this._basket[key]);
          }
        }

        if(this._total >= 50){
          this._deliveryCharge = 0;
        }
        else if(this._total == 0){
          this._deliveryCharge = 0;
        }
        else{
          this._deliveryCharge = 7;
        }
      }
    }

    $(document).ready(function () {
      var app1 = new Vue({
        el: '#app-1',
        data: {
          message: ''
        },
        methods: {
          updateCart: function () {
            console.log("changed", this.message);
          }
        }
      });

      $("#showCalculator").click(function () {
        $("#pricing-rules-div").attr("style", "display: none");
        $("#calculator-div").attr("style", "display: block");
      });

      $("#showPricingRules").click(function (){
        $("#pricing-rules-div").attr("style", "display: block");
        $("#calculator-div").attr("style", "display: none");
      });

      $("#updateInfo").click(function (){
        var cart = $("#cart").val().toUpperCase();
        let rules = new UnidaysDiscountChallenge(defaultPricingRule);

        for(var i=0; i<cart.length; i++){
          rules.addToBasket(cart[i]);
        }

        rules.calculateTotalPrice();

        var basket = rules.basket();
        $("#belowSummary").attr("style", "display: none");

        for(var key in basket){
          var label = "#" + key;
          if(basket[key]!=0){
            $("#belowSummary").attr("style", "display: block");
            $(label).attr("style", "display: block");
            $(label).html(key + ": " + basket[key]);
          }
          else{
            $(label).attr("style", "display: none");
          }
        }

        $("#deliveryDisplay").html("£" + rules.deliveryCharge());
        $("#totalDisplay").html("£ " + rules.total());
      });

      function changeFromDigit(event) {
        var item = event.data.item;
        var itemOption = "." + item + "Count";
        var summary = $("#cart").val();
        var amount = $(itemOption).val();
        var appearance = 0;

        for(var i=0; i<summary.length; i++){
          if(summary[i].toUpperCase() == item){
            appearance += Number(1);
          }
        }

        if(amount > appearance){

          while(amount > appearance){
            summary += item;
            appearance += Number(1);
          }
        }
        else if(amount < appearance){
          while(amount < appearance){
            var i=0;
            var found = false;

            while(i<summary.length && found == false){
              if(summary[i].toUpperCase() == item){
                summary = summary.substring(0, i) + summary.substring(i+1);
                found = true;
              }
              else{
                i += Number(1);
              }
            }

            appearance -= Number(1);
          }
        }

        $("#cart").val(summary);
      }

      $(".ACount").bind('input', {item: "A"}, changeFromDigit);
      $(".BCount").bind('input', {item: "B"}, changeFromDigit);
      $(".CCount").bind('input', {item: "C"}, changeFromDigit);
      $(".DCount").bind('input', {item: "D"}, changeFromDigit);
      $(".ECount").bind('input', {item: "E"}, changeFromDigit);

      $('#myDropdown').on('show.bs.dropdown', function () {
        console.log("dropdown changed");
      });
    });

    </script>
  </head>

  <body>
    <div class="container-fluid" style="width: 85%; height: 95%;">
      <div class="h-25 d-inline-block">
      </div>
      <h2>UNiDAYS Discount Challenge</h2>
      <div class="col-xs-12" style="height:1em;"></div>
      <div class="row">
        <div class="col-2">
          <button id="showCalculator" type="button" class="btn btn-default">Calculator</button>
          <div class="col-xs-12" style="height:1em;"></div>
          <button id="showPricingRules" type="button" class="btn btn-default">Pricing Rules</button>
        </div>
        <div class="col-9">
          <div id="calculator-div" style="display: block;">
            <div class="row">
              <div class="col-7">
                <h4>Items</h4>
                <div class="row" style="text-align: center">
                  <div class="col">
                    <h1>A</h1>
                    <h5>£8.00</h5>
                    <input class="ACount" type="number" value="0" min="0" style="width: 60%; text-align: center; font-size: 20px">
                  </div>
                  <div class="col">
                    <h1>B</h1>
                    <h5>£12.00</h5>
                    <input class="BCount" type="number" value="0" min="0" style="width: 60%; text-align: center; font-size: 20px">
                  </div>
                  <div class="col">
                    <h1>C</h1>
                    <h5>£4.00</h5>
                    <input class="CCount" type="number" value="0" min="0" style="width: 60%; text-align: center; font-size: 20px">
                  </div>
                </div>
                <div class="col-xs-12" style="height:1em;"></div>
                <div class="row" style="text-align: center">
                  <div class="col">
                    <h1>D</h1>
                    <h5>£7.00</h5>
                    <input class="DCount" type="number" value="0" min="0" style="width: 60%; text-align: center; font-size: 20px">
                  </div>
                  <div class="col">
                    <h1>E</h1>
                    <h5>£5.00</h5>
                    <input class="ECount" type="number" value="0" min="0" style="width: 60%; text-align: center; font-size: 20px">
                  </div>
                  <div class="col">
                  </div>
                </div>
                <div class="col-xs-12" style="height:3em;"></div>
                <div class="row">
                  <div class="col" id="app-1">
                    <input id="cart" type="text" class="form-control" v-model="message" v-on:change="updateCart" style="width: 100%;">
                    <p>{{ message }}</p>
                  </div>
                  <div class="col">
                    <button id="updateInfo" class="btn btn-default">Get price</button></div>
                  </div>
              </div>
              <div class="col-2">
                <h4>Summary</h4>
                <hr size="5" id="belowSummary" style="display: none;">
                <div id="itemNone" style="display: block"></div>
                <div id="A" style="display: none;"></div>
                <div id="B" style="display: none;"></div>
                <div id="C" style="display: none;"></div>
                <div id="D" style="display: none;"></div>
                <div id="E" style="display: none;"></div>
                <div id="F" style="display: none;"></div>
                <hr size="5">
                <h5>Delivery</h5>
                <h6 id="deliveryDisplay">£0.00</h6>
                <h5>Total</h5>
                <h6 id="totalDisplay">£0.00</h6>
              </div>
            </div>
          </div>
          <div id="pricing-rules-div" style="display: none;">
            <h4>Pricing Policies</h4>
            <div class="col-xs-12" style="height:1em;"></div>

            <div class="row">
              <div class="col-2">
                <h3>Item</h3>
              </div>
              <div class="col-4">
                <h3>Price</h3>
              </div>
              <div class="col-6">
                <h3>Discount</h3>
              </div>
            </div>
            <div class="col-xs-12" style="height:1em;"></div>

            <div class="row">
              <div class="col-2">
                <h4>A</h4>
              </div>
              <div class="col-4">
                <h4>£8.00</h4>
              </div>
              <div class="col-6">
                <div class="btn-group" id="myDropdown">
                  <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="vertical-align: middle">
                    None
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">None</a>
                    <a class="dropdown-item" href="#">x for £..</a>
                    <a class="dropdown-item" href="#">Buy x get y free</a>
                    <a class="dropdown-item" href="#">x for the price of y</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xs-12" style="height:1em;"></div>

            <div class="row">
              <div class="col-2">
                <h4>B</h4>
              </div>
              <div class="col-4">
                <h4>£12.00</h4>
              </div>
              <div class="col-6">
                <div class="btn-group">
                  <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="vertical-align: middle">
                    x for £..
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">None</a>
                    <a class="dropdown-item" href="#">x for £..</a>
                    <a class="dropdown-item" href="#">Buy x get y free</a>
                    <a class="dropdown-item" href="#">x for the price of y</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xs-12" style="height:1em;"></div>

            <div class="row">
              <div class="col-2">
                <h4>C</h4>
              </div>
              <div class="col-4">
                <h4>£4.00</h4>
              </div>
              <div class="col-6">
                <div class="btn-group">
                  <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="vertical-align: middle">
                    x for £..
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">None</a>
                    <a class="dropdown-item" href="#">x for £..</a>
                    <a class="dropdown-item" href="#">Buy x get y free</a>
                    <a class="dropdown-item" href="#">x for the price of y</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xs-12" style="height:1em;"></div>

            <div class="row">
              <div class="col-2">
                <h4>D</h4>
              </div>
              <div class="col-4">
                <h4>£7.00</h4>
              </div>
              <div class="col-6">
                <div class="btn-group">
                  <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="vertical-align: middle">
                    Buy x get y free
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">None</a>
                    <a class="dropdown-item" href="#">x for £..</a>
                    <a class="dropdown-item" href="#">Buy x get y free</a>
                    <a class="dropdown-item" href="#">x for the price of y</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xs-12" style="height:1em;"></div>

            <div class="row">
              <div class="col-2">
                <h4>E</h4>
              </div>
              <div class="col-4">
                <h4>£5.00</h4>
              </div>
              <div class="col-6">
                <div class="btn-group">
                  <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="vertical-align: middle">
                    x for the price of y
                  </button>
                  <div class="dropdown-menu">
                    <a class="dropdown-item" href="#">None</a>
                    <a class="dropdown-item" href="#">x for £..</a>
                    <a class="dropdown-item" href="#">Buy x get y free</a>
                    <a class="dropdown-item" href="#">x for the price of y</a>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-xs-12" style="height:1em;"></div>

          </div>
        </div>
      </div>
    </div>
  </body>
</html>
